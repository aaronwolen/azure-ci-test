trigger:
  branches:
    include:
      - master
  tags:
    include:
      - "*"

jobs:
- job: Setup

  strategy:
    matrix:
      linux18:
        imageName: 'ubuntu-18.04'
        python.version: '3.x'
      linux16:
        imageName: 'ubuntu-16.04'
        python.version: '3.x'

  pool:
    vmImage: $(imageName)
  variables:
    tag: '$(Build.BuildId)'

  steps:

  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: 'env | sort'

  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(python.version)'
      architecture: 'x64'

- job: Images

  strategy:
    matrix:
      image1:
        dockerfile: Dockerfile
        repository: aaronwolen/azure-ci-test
      image2:
        dockerfile: Dockerfile-sh
        repository: aaronwolen/azure-ci-test-2

  steps:
  - template: ci/build-images.yml
  - task: Docker@2
    displayName: Docker image (latest)
    condition: or(eq(variables['build.sourceBranch'], 'refs/heads/master'), startsWith(variables['build.sourceBranch'], 'refs/tags'))
    inputs:
      containerRegistry: 'Docker Hub'
      repository: $(repository)
      command: 'buildAndPush'
      Dockerfile: $(dockerfile)
      buildContext: '.'
      tags: latest

  - task: Docker@2
    displayName: Docker image (tagged release)
    condition: startsWith(variables['build.sourceBranch'], 'refs/tags')
    inputs:
      containerRegistry: 'Docker Hub'
      repository: $(repository)
      command: 'buildAndPush'
      Dockerfile: $(dockerfile)
      buildContext: '.'
      tags: $(Build.SourceBranchName)
